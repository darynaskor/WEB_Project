# Image Manager: Асинхронний Сервіс Обробки Зображень

## Оновлення: монорепозиторій з окремими frontend / backend

## HTTPS та авторизація

- Сервер працює **по HTTPS**. Стандарні шляхи до самопідписаного сертифіката: `backend/src/certs/server.crt`, ключ: `backend/src/certs/server.key`. Можна змінити через змінні `CERT_PATH` та `KEY_PATH`.
- Приклад генерації сертифіката:
  ```bash
  mkdir -p backend/src/certs
  openssl req -x509 -newkey rsa:2048 \\
    -keyout backend/src/certs/server.key \\
    -out backend/src/certs/server.crt \\
    -days 365 -nodes -subj "/CN=localhost"
  ```
  Після цього додайте сертифікат до довірених у браузері (для Chrome/Safari — подвійний клік на `.crt`).

- Токени видаються за допомогою JWT. Змінна `JWT_SECRET` дозволяє встановити власний секрет. Термін дії токена — 2 години (`JWT_EXPIRES_IN`).
- API ендпоїнти для авторизації:
  - `POST /api/auth/register` — реєстрація (email + пароль)
  - `POST /api/auth/login` — вхід, повертає `{ user, token }`
  - усі `/api/tasks/*` потребують заголовка `Authorization: Bearer <token>` і повертають дані лише поточного користувача.
- У фронтенді зʼявилась форма входу/реєстрації. Після успішної авторизації токен зберігається у `localStorage`, і можна запускати обробку.


## Опис проєкту
**Image Manager** — веб-застосунок для **завантаження, обробки та редагування зображень** із використанням React.  
Основна функція системи — **завантаження фото з комп’ютера, застосування фільтрів та ефектів, збереження результату**, із відстеженням прогресу завантаження та змін.  
Додатково підтримується функціонал **Reset** (повернення зображення до початкового стану) та **Back** (відкат одного кроку редагування).

---

## Вимоги

### Обмеження
- Максимальний розмір файлу для завантаження: **5 MB**  
- Усі завантажені зображення обрізаються до **єдиного розміру** (наприклад, 600x400px)  
- Під час редагування застосовуються лише обрані фільтри  

---

### Хід виконання задачі
1. **10%** — підготовка (вибір файлу, перевірка розміру)  
2. **50%** — завантаження та обрізка/масштабування  
3. **90%** — застосування фільтрів та обробка зображення  
4. **100%** — готово (завантажене та оброблене зображення відображається на сторінці)  

---

### Історія редагувань
Зберігається інформація про:  
- Поточний стан фільтрів  
- Попередні кроки редагування для функції **Back**  
- Завантажене зображення та його URL  

---

### Функціонал користувача
- Завантаження зображень з комп’ютера  
- Застосування фільтрів (Brightness, Contrast, Saturation, Grayscale, Sepia, Hue, Blur)  
- Використання кнопок **Reset** та **Back**  
- Перегляд прогресу завантаження та обробки  

---

### Прогрес-бар
- Відображає **хід завантаження та обробки зображення**  
- Показує етапи: підготовка → завантаження → обробка → готово  
- З’являється лише під час завантаження/обробки  

---

### Інтерфейс користувача
- **Toolbar**: PROFILE, HISTORY, LOGOUT  
- **Sidebar**: список фільтрів, кнопки Reset, Back та Upload  
- **Main Image**: відображення завантаженого та обробленого зображення  
- **Slider**: регулювання інтенсивності вибраного фільтру  

---

### Безпека
- Всі запити виконуються через **HTTPS**  
- Перевірка розміру файлу перед завантаженням  
- Обмеження на формат файлів (JPG, PNG)  

---

### Можливе розширення
- Збереження оброблених зображень у локальній колекції користувача  
- Завантаження кількох зображень одночасно  
- Підтримка додаткових фільтрів та ефектів  

---

## Структура проєкту

Репозиторій розбитий на два npm-workspace:

```
.
├─ package.json          # Workspaces + загальні скрипти
├─ frontend/             # Vite + React
│  ├─ package.json
│  ├─ index.html
│  └─ src/
│     ├─ api/            # fetch-хелпери (auth, tasks)
│     ├─ components/
│     │  └─ App/         # AppContainer + підкомпоненти UI
│     ├─ config/         # DEFAULT_OPTIONS, MAX_TASK_COMPLEXITY
│     └─ utils/          # buildFilterString, history helpers, image helpers
└─ backend/              # HTTPS load balancer + application servers
   ├─ package.json
   └─ src/
      ├─ load-balancer.cjs  # Round-robin HTTPS → HTTP
      ├─ index.cjs          # Одинокий сервер (без LB)
      ├─ createApp.cjs      # Express-додаток (JWT, черга, CORS, очистка)
      ├─ db.cjs             # Ініціалізація SQLite
      └─ certs/             # Самопідписані сертифікати (локальні)
```

## Запуск

> Перший запуск: `npm install` в корені встановить залежності обох workspace.

### 1. Бекенд (HTTPS load balancer + два application server-и)

```bash
npm run backend:start
```

- LB слухає `https://localhost:4000` і розподіляє запити на `http://localhost:5001` та `http://localhost:5002`.  
- Кастомні порти: `APP_SERVER_PORTS="5001,5002,5003" npm run backend:start`.  
- Обмеження активних задач: `MAX_ACTIVE_TASKS` (стандартно 5). Для демонстрації черги:

```bash
npm run backend:start:max1   # MAX_ACTIVE_TASKS=1
```

- Спрощений режим без балансувальника:

```bash
npm run backend:start:single
```

### 2. Фронтенд (Vite)

```bash
npm run frontend:dev
```

За замовчуванням фронтенд звертається до `https://localhost:4000/api`. Можна задати `VITE_API_BASE` у `.env`.

### 3. Авторизація та токени

1. Зареєструйтесь або увійдіть. Бекенд поверне `{ user, token }`.
2. `AppContainer` зберігає токен у `localStorage` (`image-manager-token`) і використовує для запитів (`Authorization: Bearer <token>`).
3. При завершенні/виході натисніть «Вийти», щоб очистити токен.

### 4. Черга задач

- Якщо вичерпано `MAX_ACTIVE_TASKS`, `POST /api/tasks` повертає `202` з `queued=true`, `queuePosition`, `estimatedWaitSeconds`.
- Фронтенд показує статус «У черзі» та кожні 5 секунд пробує активувати задачу.
- Бекенд автоматично очищує "завислі" задачі — після `STALE_TASK_TIMEOUT_SECONDS` (120с) статус `queued` → `cancelled`, `running` → `failed`.

### 5. Перевірка load balancing

```bash
curl -k https://localhost:4000/health
```

Відповіді будуть чергуватись між `serverId: "app-1"` та `serverId: "app-2"`, що засвідчує роботу round-robin LB.

## Ключові можливості

- Обмеження складності задачі на фронтенді (`MAX_TASK_COMPLEXITY`).
- JWT-авторизація, HTTPS-з’єднання, CORS whitelist.
- Історія задач та статуси зберігаються в SQLite (`backend/src/tasks.db`).
- Керування чергою, обмеження активних задач, автоматичне очищення застарілих записів.
- UI: прогрес-бар, undo/redo (Back/Reset), історія фільтрів, завантаження результату.

Готово до розгортання на локальній машині та демонстрації вимог. !*** End Patch
   
